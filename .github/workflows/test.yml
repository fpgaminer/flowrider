name: Test
on:
  pull_request:
  push:

jobs:
  check:
    name: Check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo check --all-features
  
  fmt:
    name: Check formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check
  
  clippy:
    name: Check for linting errors
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - run: cargo clippy --all-features -- -D warnings
  
  test:
    name: Run test suite
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy
      - run: cargo test --no-default-features --features auto-initialize
  
  python-wheel:
    name: Test wheel building
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.10"]   # could add more versions here
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: ${{ matrix.python-version }}
      - name: Set PYTHON for PyO3
        run: echo "PYO3_PYTHON=${pythonLocation}/bin/python" >> $GITHUB_ENV
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install "setuptools>=48" wheel "setuptools-rust>=1.0" numpy
          python -m pip install --index-url https://download.pytorch.org/whl/cpu torch
      - name: pip install .
        run: python -m pip install .

      - name: Smoke-test import
        run: |
          python - << 'PY'
          import importlib, sys, pathlib, textwrap
          import flowrider                           # â† if this fails, the wheel is broken
          print("flowrider imported from", flowrider.__file__)
          # ultra-light sanity check: construct a Config and print it
          cfg = flowrider.Config(
              cache_dir="tmp_cache",
              cache_limit=0,
              max_downloads=1,
              num_cache_workers=None,
              local_rank=0,
              global_rank=0,
              world_size=1,
              master_addr=None,
              master_port=None,
          )
          print("Constructed Config OK:", cfg)
          PY
